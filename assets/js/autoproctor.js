(()=>{if(!document.getElementById("ap-preflight-modal")){const e=document.createElement("style");e.innerHTML="\n  #ap-preflight-modal { position: fixed; inset: 0; display:flex;align-items:center;justify-content:center;\n    background: rgba(0,0,0,0.5); z-index: 99999; }\n  #ap-preflight-card { background: #fff; padding: 18px; border-radius: 8px; width: 420px; max-width: 92%; box-shadow:0 6px 24px rgba(0,0,0,.25); font-family: Arial, sans-serif;}\n  #ap-preflight-card h3 { margin:0 0 8px 0; font-size:18px; }\n  #ap-preflight-card p { margin:6px 0 12px 0; font-size:13px; color:#333; }\n  #ap-preflight-status { font-size:13px; margin-bottom:12px; min-height:20px; }\n  #ap-preflight-actions { display:flex; gap:8px; justify-content:flex-end; }\n  .ap-btn { padding:8px 12px; border-radius:6px; cursor:pointer; border:1px solid #ccc; background:#f7f7f7; }\n  .ap-btn.primary { background:#0366d6; color:#fff; border-color:transparent; }\n  ",document.head.appendChild(e);const t=document.createElement("div");t.id="ap-preflight-modal",t.style.display="none",t.innerHTML='\n    <div id="ap-preflight-card" role="dialog" aria-modal="true" aria-labelledby="ap-preflight-title">\n      <h3 id="ap-preflight-title">Pre-check: Microphone & Screen</h3>\n      <p>Please allow microphone & screen sharing so proctoring can start. We\'ll record the screen and audio for the test session.</p>\n      <div id="ap-preflight-status"></div>\n      <div id="ap-preflight-actions">\n        <button class="ap-btn" id="ap-preflight-cancel">Cancel</button>\n        <button class="ap-btn primary" id="ap-preflight-allow">Allow & Start</button>\n      </div>\n    </div>\n  ',document.body.appendChild(t)}function e(){document.getElementById("ap-preflight-modal").style.display="none",document.getElementById("ap-preflight-status").textContent=""}const t={pending:!1};document.addEventListener("click",async n=>{const i=n.target.closest('.wpProQuiz_button[name="startQuiz"], .wpProQuiz_button[name="restartQuiz"], .ld-quiz-start, .quiz_continue_link');if(!i)return;if(started||t.pending)return void(t.pending&&n.preventDefault());n.preventDefault(),t.pending=!0,function(e=""){const t=document.getElementById("ap-preflight-modal");document.getElementById("ap-preflight-status").textContent=e,t.style.display="flex"}("Waiting for your permission...");const r=document.getElementById("ap-preflight-allow"),a=document.getElementById("ap-preflight-cancel"),o=()=>{r.onclick=null,a.onclick=null};a.onclick=()=>{o(),e(),t.pending=!1},r.onclick=async()=>{r.disabled=!0,a.disabled=!0,document.getElementById("ap-preflight-status").textContent="Requesting mic permission...";try{await async function(){const e=await navigator.mediaDevices.getUserMedia({audio:!0}).catch(e=>{throw{type:"mic",error:e}}),t=await navigator.mediaDevices.getDisplayMedia({video:!0}).catch(t=>{throw e.getTracks().forEach(e=>e.stop()),{type:"screen",error:t}});return e.getTracks().forEach(e=>e.stop()),t.getTracks().forEach(e=>e.stop()),!0}(),document.getElementById("ap-preflight-status").textContent="Permissions granted. Initializing proctoring...";const n=()=>{document.getElementById("ap-preflight-status").textContent="Proctoring started â€” launching quiz...",setTimeout(()=>{e(),o(),t.pending=!1,function(e){try{if(e&&"function"==typeof e.click)setTimeout(()=>e.click(),20);else{const e=document.querySelector("form");e&&e.submit()}}catch(e){console.warn("[JRJ AP] proceedWithOriginalAction failed",e)}}(i)},500),window.removeEventListener("apMonitoringStarted",n)};window.addEventListener("apMonitoringStarted",n);try{await startProctoring()}catch(i){console.error("[JRJ AP] startProctoring error:",i),document.getElementById("ap-preflight-status").textContent="Failed to start proctoring. Please refresh or contact support.",window.removeEventListener("apMonitoringStarted",n),o(),t.pending=!1,setTimeout(e,2500)}}catch(e){console.warn("[JRJ AP] permission error",e);let n="Permission denied. Microphone and screen sharing are required.";e&&"screen"===e.type&&(n="Screen sharing was denied. Please allow screen sharing."),e&&"mic"===e.type&&(n="Microphone permission was denied. Please allow microphone."),document.getElementById("ap-preflight-status").textContent=n,r.disabled=!1,a.disabled=!1,t.pending=!1}}},{capture:!0})})();